<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Przeglądarka Bazy Pytań SQLite</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- sql.js for reading SQLite database in the browser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js" crossorigin="anonymous"></script>
    <!-- D3.js and d3-cloud for word clouds -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jasondavies/d3-cloud@1.2.7/build/d3.layout.cloud.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
        .wordcloud-container {
            position: relative;
            height: 40vh;
            width: 100%;
            cursor: pointer;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .drag-area-highlight {
            border-color: #2563eb;
            background-color: #eff6ff;
        }
        .card-tag {
            display: inline-block;
            background-color: #e0e7ff;
            color: #4338ca;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 6px;
            margin-bottom: 6px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto p-4 md:p-8">
    <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900">Interaktywna Przeglądarka Bazy Pytań</h1>
        <p id="header-subtitle" class="text-lg text-gray-600 mt-2">Przeciągnij i upuść plik bazy danych SQLite, aby zwizualizować dane.</p>
    </header>

    <main>
        <!-- Drop zone for the database file -->
        <div id="drop-area" class="border-4 border-dashed border-gray-300 rounded-xl p-8 text-center bg-white shadow-md transition-all duration-300 cursor-pointer hover:border-blue-500 hover:bg-blue-50">
            <div id="drop-area-content">
                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="mt-2 text-xl font-semibold text-gray-700">Upuść plik <span class="text-blue-600">.db</span> tutaj</p>
                <p class="text-sm text-gray-500">lub kliknij, aby wybrać plik</p>
                <input type="file" id="file-input" class="hidden" accept=".db,.sqlite,.sqlite3">
            </div>
            <div id="loading-indicator" class="hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-4 text-lg font-medium text-gray-700">Przetwarzanie bazy danych...</p>
            </div>
        </div>

        <!-- Error message display -->
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative my-4" role="alert">
            <strong class="font-bold">Błąd!</strong>
            <span class="block sm:inline" id="error-text"></span>
        </div>

        <!-- Main content area for stats and questions -->
        <div id="content-area" class="hidden mt-8">
            <!-- Statistics Section -->
            <section id="stats-section">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 pb-2 border-b-2 border-gray-200">Statystyki Bazy Danych</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">Kategorie</h3>
                        <div id="category-wordcloud" class="wordcloud-container"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">Subkategorie</h3>
                        <div id="subcategory-wordcloud" class="wordcloud-container"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">Słowa Kluczowe</h3>
                        <div id="keys-wordcloud" class="wordcloud-container"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700">Pytania wg Modelu</h3>
                        <div class="chart-container"><canvas id="model-chart"></canvas></div>
                    </div>
                </div>
            </section>

            <!-- Questions List Section -->
            <section id="questions-section" class="mt-12">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 pb-2 border-b-2 border-gray-200">Przeglądaj Pytania</h2>

                <!-- Controls: Search and Sort -->
                <div class="flex flex-col md:flex-row gap-4 mb-6 bg-white p-4 rounded-xl shadow-md">
                    <div class="relative flex-grow">
                        <input type="text" id="search-input" placeholder="Wyszukaj w pytaniach..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                    <div class="flex-shrink-0">
                        <select id="sort-select" class="w-full md:w-auto px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="created_at_desc">Najnowsze</option>
                            <option value="created_at_asc">Najstarsze</option>
                            <option value="category_asc">Kategoria (A-Z)</option>
                            <option value="category_desc">Kategoria (Z-A)</option>
                        </select>
                    </div>
                </div>

                <!-- Questions Container -->
                <div id="questions-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Question cards will be injected here -->
                </div>

                <!-- Pagination -->
                <div id="pagination-controls" class="flex justify-center items-center mt-8 space-x-2">
                    <!-- Pagination buttons will be injected here -->
                </div>
            </section>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // DOM Elements
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const dropAreaContent = document.getElementById('drop-area-content');
        const loadingIndicator = document.getElementById('loading-indicator');
        const contentArea = document.getElementById('content-area');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const searchInput = document.getElementById('search-input');
        const sortSelect = document.getElementById('sort-select');
        const questionsContainer = document.getElementById('questions-container');
        const paginationControls = document.getElementById('pagination-controls');
        const headerSubtitle = document.getElementById('header-subtitle');

        // App State
        let db = null;
        let charts = {};
        let allQuestions = [];
        let filteredQuestions = [];
        let currentPage = 1;
        const ITEMS_PER_PAGE = 9;
        let wordCloudData = {}; // Store data for redraws

        // Global error handler
        window.onerror = function(message, source, lineno, colno, error) {
            showError(`Krytyczny błąd skryptu: ${message}`);
            console.error("Uncaught Error:", { message, source, lineno, colno, error });
            return true;
        };

        // Initialize sql.js
        const sqlJsPromise = initSqlJs({
            locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
        }).catch(e => {
            showError("Nie można załadować biblioteki SQL. Sprawdź połączenie internetowe.");
            console.error("SQL.js initialization failed:", e);
            return null;
        });

        // Event Listeners
        dropArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        searchInput.addEventListener('input', () => {
            currentPage = 1;
            renderApp();
        });
        sortSelect.addEventListener('change', () => {
            currentPage = 1;
            renderApp();
        });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, preventDefaults, false));
        ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('drag-area-highlight'), false));
        ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('drag-area-highlight'), false));
        dropArea.addEventListener('drop', (e) => {
            preventDefaults(e);
            handleFile(e.dataTransfer.files[0]);
        }, false);

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function showLoading(isLoading) {
            loadingIndicator.classList.toggle('hidden', !isLoading);
            dropAreaContent.classList.toggle('hidden', isLoading);
            if(isLoading) {
                contentArea.classList.add('hidden');
                errorMessage.classList.add('hidden');
            }
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            showLoading(false);
            dropArea.classList.remove('hidden');
        }

        async function handleFileContent(uInt8Array, sourceName) {
            showLoading(true);
            try {
                const SQL = await sqlJsPromise;
                if (!SQL) {
                    showError("Nie można zainicjować SQL.js.");
                    return;
                }
                db = new SQL.Database(uInt8Array);
                processDatabase(sourceName);
            } catch (err) {
                showError(`Błąd podczas przetwarzania bazy danych z ${sourceName}: ${err.message}`);
                console.error(err);
            }
        }

        function handleFile(file) {
            if (!file || (!file.name.endsWith('.db') && !file.name.endsWith('.sqlite') && !file.name.endsWith('.sqlite3'))) {
                showError("Nieprawidłowy format pliku. Proszę upuścić plik .db, .sqlite lub .sqlite3.");
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const uInt8Array = new Uint8Array(e.target.result);
                handleFileContent(uInt8Array, file.name);
            };
            reader.readAsArrayBuffer(file);
        }

        function processDatabase(sourceName) {
            try {
                const tableCheckStmt = db.prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='generated_questions'");
                if (!tableCheckStmt.step()) {
                    tableCheckStmt.free();
                    showError(`Tabela 'generated_questions' nie została znaleziona w bazie danych: ${sourceName}.`);
                    return;
                }
                tableCheckStmt.free();

                const stmt = db.prepare("SELECT * FROM generated_questions");
                allQuestions = [];
                while (stmt.step()) {
                    allQuestions.push(stmt.getAsObject());
                }
                stmt.free();

                if (allQuestions.length === 0) {
                    showError(`Nie znaleziono żadnych pytań w tabeli 'generated_questions' w pliku: ${sourceName}.`);
                    return;
                }

                if (allQuestions[0] && 'created_at' in allQuestions[0]) {
                    allQuestions.sort((a, b) => (b.created_at || '').localeCompare(a.created_at || ''));
                }

                contentArea.classList.remove('hidden');
                dropArea.classList.add('hidden');
                headerSubtitle.textContent = `Wyświetlanie danych z: ${sourceName}`;

                prepareStatistics(allQuestions);
                renderApp();

            } catch (e) {
                showError(`Błąd podczas odpytywania bazy danych: ${e.message}`);
                console.error(e);
            } finally {
                showLoading(false);
            }
        }

        async function tryAutoLoadDatabase() {
            try {
                const response = await fetch('data/questions.db');
                if (response.ok) {
                    const arrayBuffer = await response.arrayBuffer();
                    const uInt8Array = new Uint8Array(arrayBuffer);
                    dropArea.classList.add('hidden');
                    loadingIndicator.classList.remove('hidden');
                    await handleFileContent(uInt8Array, 'data/questions.db');
                } else {
                    console.log('Default database data/questions.db not found. Waiting for user to drop a file.');
                    dropArea.classList.remove('hidden');
                }
            } catch (error) {
                console.log('Error trying to fetch default database. Waiting for user to drop a file.', error);
                dropArea.classList.remove('hidden');
            }
        }

        function renderApp() {
            try {
                const searchTerm = searchInput.value.toLowerCase();
                filteredQuestions = allQuestions.filter(q =>
                    (q.question_text || '').toLowerCase().includes(searchTerm) ||
                    (q.answer_text || '').toLowerCase().includes(searchTerm) ||
                    (q.category || '').toLowerCase().includes(searchTerm)
                );

                const [sortKey, sortOrder] = sortSelect.value.split('_');
                if (sortKey === 'created_at' && allQuestions[0] && 'created_at' in allQuestions[0]) {
                    const isAsc = sortOrder === 'asc';
                    filteredQuestions.sort((a, b) => {
                        const dateA = a.created_at ? new Date(a.created_at).getTime() : 0;
                        const dateB = b.created_at ? new Date(b.created_at).getTime() : 0;
                        return isAsc ? dateA - dateB : dateB - dateA;
                    });
                } else {
                    filteredQuestions.sort((a, b) => {
                        const valA = a[sortKey] || '';
                        const valB = b[sortKey] || '';
                        let comparison = String(valA).localeCompare(String(valB));
                        return sortOrder === 'desc' ? comparison * -1 : comparison;
                    });
                }

                displayPaginatedQuestions();
                renderPagination();
            } catch (e) {
                showError(`Błąd podczas renderowania aplikacji: ${e.message}`);
                console.error(e);
            }
        }

        function displayPaginatedQuestions() {
            questionsContainer.innerHTML = '';
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;
            const paginatedItems = filteredQuestions.slice(startIndex, endIndex);

            if (paginatedItems.length === 0) {
                questionsContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">Brak pytań spełniających kryteria.</p>`;
                return;
            }

            paginatedItems.forEach(q => {
                const card = document.createElement('div');
                card.className = 'bg-white p-6 rounded-xl shadow-md flex flex-col gap-4';

                let optionsHTML = 'Brak';
                try {
                    const options = JSON.parse(q.options_json || '[]');
                    if (options && Array.isArray(options) && options.length > 0) {
                        optionsHTML = `<ul class="list-disc list-inside">${options.map(opt => `<li>${opt}</li>`).join('')}</ul>`;
                    }
                } catch (e) { console.error("Error parsing options_json", e); }

                let keysHTML = 'Brak';
                try {
                    const keys = JSON.parse(q.key_entities_json || '[]');
                    if (keys && Array.isArray(keys) && keys.length > 0) {
                        keysHTML = keys.map(key => `<span class="card-tag">${key}</span>`).join('');
                    }
                } catch (e) { console.error("Error parsing key_entities_json", e); }

                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start">
                            <span class="text-sm font-semibold text-indigo-600 bg-indigo-100 px-2 py-1 rounded">${q.category || 'Brak kategorii'}</span>
                            <span class="text-xs text-gray-500">${q.model || 'Brak modelu'}</span>
                        </div>
                        <h3 class="text-lg font-bold mt-2">${q.question_text || 'Brak pytania'}</h3>
                    </div>
                    <div>
                        <p class="font-semibold text-green-700">Odpowiedź: ${q.answer_text || 'Brak odpowiedzi'}</p>
                    </div>
                    <div class="text-sm text-gray-600">
                        <p class="font-semibold">Wyjaśnienie:</p>
                        <p>${q.explanation || 'Brak wyjaśnienia.'}</p>
                    </div>
                    <div class="text-sm">
                        <p class="font-semibold">Opcje:</p>
                        ${optionsHTML}
                    </div>
                     <div class="text-sm">
                        <p class="font-semibold">Słowa kluczowe:</p>
                        <div>${keysHTML}</div>
                    </div>
                    <div class="text-xs text-gray-400 mt-auto pt-2 border-t">
                        Subkategoria: ${q.subcategory || 'Brak'} | Poziom: ${q.knowledge_level || 'Brak'} | Utworzono: ${q.created_at ? new Date(q.created_at).toLocaleString('pl-PL') : 'Brak daty'}
                    </div>
                `;
                questionsContainer.appendChild(card);
            });
        }

        function renderPagination() {
            paginationControls.innerHTML = '';
            const pageCount = Math.ceil(filteredQuestions.length / ITEMS_PER_PAGE);
            if (pageCount <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Poprzednia';
            prevButton.className = 'px-4 py-2 rounded-md text-sm font-medium bg-white text-gray-700 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => {
                currentPage--;
                renderApp();
                window.scrollTo(0, questionsContainer.offsetTop);
            };

            const pageInfo = document.createElement('span');
            pageInfo.className = 'px-4 py-2 text-sm font-medium text-gray-700';
            pageInfo.textContent = `Strona ${currentPage} z ${pageCount}`;

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Następna';
            nextButton.className = 'px-4 py-2 rounded-md text-sm font-medium bg-white text-gray-700 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed';
            nextButton.disabled = currentPage === pageCount;
            nextButton.onclick = () => {
                currentPage++;
                renderApp();
                window.scrollTo(0, questionsContainer.offsetTop);
            };

            paginationControls.append(prevButton, pageInfo, nextButton);
        }

        function prepareStatistics(questions) {
            if (charts.model) {
                charts.model.destroy();
            }

            wordCloudData.category = Object.entries(countBy(questions, 'category'));
            wordCloudData.subcategory = Object.entries(countBy(questions, 'subcategory'));

            const keyEntitiesCounts = questions.reduce((acc, q) => {
                try {
                    const keys = JSON.parse(q.key_entities_json || '[]');
                    if (Array.isArray(keys)) {
                        keys.forEach(key => {
                            const trimmedKey = key.trim();
                            if (trimmedKey) {
                                acc[trimmedKey] = (acc[trimmedKey] || 0) + 1;
                            }
                        });
                    }
                } catch (e) {}
                return acc;
            }, {});
            wordCloudData.keys = Object.entries(keyEntitiesCounts);

            const modelCounts = countBy(questions, 'model');
            charts.model = createChart('model-chart', 'polarArea', modelCounts, 'Pytania wg Modelu');

            // Trigger redraw after a short delay to ensure containers are visible
            setTimeout(drawWordClouds, 100);
        }

        function drawWordClouds() {
            createWordCloud('category-wordcloud', wordCloudData.category);
            createWordCloud('subcategory-wordcloud', wordCloudData.subcategory);
            createWordCloud('keys-wordcloud', wordCloudData.keys);
        }

        function countBy(data, key) {
            return data.reduce((acc, item) => {
                const value = item[key];
                if (value) {
                    acc[value] = (acc[value] || 0) + 1;
                }
                return acc;
            }, {});
        }

        function createWordCloud(elementId, list) {
            const element = document.getElementById(elementId);
            if (!element) return;

            element.innerHTML = '';

            if (list.length === 0) {
                element.innerHTML = '<p class="text-center text-gray-500 h-full flex items-center justify-center">Brak danych do wyświetlenia.</p>';
                return;
            };

            const observer = new ResizeObserver(entries => {
                if (entries[0].contentRect.width > 0) {
                    if (typeof d3 !== 'undefined' && typeof d3.layout.cloud !== 'undefined') {
                        drawD3Cloud(element, list);
                    } else {
                        console.error("D3 or d3-cloud library is not loaded.");
                        element.innerHTML = '<p class="text-center text-red-500 h-full flex items-center justify-center">Błąd ładowania biblioteki chmury słów.</p>';
                    }
                    observer.disconnect();
                }
            });

            observer.observe(element);
        }

        function drawD3Cloud(element, list) {
            const width = element.offsetWidth;
            const height = element.offsetHeight;

            const words = list.map(item => ({ text: item[0], size: item[1] }));

            const maxSize = d3.max(words, d => d.size);
            const fontSizeScale = d3.scaleSqrt()
                .domain([0, maxSize])
                .range([12, 55]); // Adjusted font size range for more words

            const layout = d3.layout.cloud()
                .size([width, height])
                .words(words)
                .padding(4) // Adjusted padding
                .rotate(() => (~~(Math.random() * 2) * 90))
                .font("Inter")
                .fontSize(d => fontSizeScale(d.size))
                .on("end", draw);

            layout.start();

            function draw(words) {
                d3.select(element).append("svg")
                    .attr("width", layout.size()[0])
                    .attr("height", layout.size()[1])
                    .append("g")
                    .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")")
                    .selectAll("text")
                    .data(words)
                    .enter().append("text")
                    .style("font-size", d => d.size + "px")
                    .style("font-family", "Inter")
                    .style("fill", () => `hsl(${Math.random() * 360}, 70%, 50%)`)
                    .style("text-shadow", "1px 1px 2px rgba(0,0,0,0.2)")
                    .attr("text-anchor", "middle")
                    .attr("transform", d => "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")")
                    .text(d => d.text)
                    .style("cursor", "pointer")
                    .on("click", (event, d) => {
                        searchInput.value = d.text;
                        searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                    });
            }
        }

        function createChart(canvasId, type, data, label) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const backgroundColors = [
                'rgba(54, 162, 235, 0.8)', 'rgba(255, 99, 132, 0.8)', 'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)', 'rgba(153, 102, 255, 0.8)', 'rgba(255, 159, 64, 0.8)',
                'rgba(199, 199, 199, 0.8)', 'rgba(83, 102, 255, 0.8)', 'rgba(40, 159, 64, 0.8)'
            ];
            const borderColors = backgroundColors.map(color => color.replace('0.8', '1'));

            return new Chart(ctx, {
                type: type,
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: label,
                        data: Object.values(data),
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: type === 'bar' ? 'top' : 'right' } }
                }
            });
        }

        // Start the app by trying to autoload the database
        tryAutoLoadDatabase();
    });
</script>
</body>
</html>
